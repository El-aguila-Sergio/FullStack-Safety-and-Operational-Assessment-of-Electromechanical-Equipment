<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>气象监测大屏</title>
    <!-- 引入 ECharts 和 jQuery -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        /* 确保 body 占满整个视口 */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            /* overflow: hidden; */
        }

        /* 整体背景 - 科技感更强的机械未来风格 */
        body {
            background: 
                linear-gradient(rgba(74, 85, 112, 0.8), rgba(66, 80, 122, 0.8)),
                url('https://vcg00.cfp.cn/creative/vcg/800/new/VCG41N1358149692.jpg');
            background-size: cover;
            background-position: center;
            color: #e0e0e0;
        }

        /* 创建Flexbox布局 */
        .container {
            display: flex;
            height: calc(100% - 80px);
            position: relative;
            margin-top: 10px;
        }

        /* 地图容器样式 */
        #echarts-map {
            flex: 3;
            height: 100%;
            position: relative;
            margin-left: 10px;
            margin-top: 8px;
            border-radius: 8px;
            box-shadow: 0 0 20px rgba(0, 200, 255, 0.2);
            background: rgba(177, 179, 184, 0.5);
            overflow: hidden;
            border: 1px solid rgba(0, 180, 255, 0.3);
        }

        /* 右侧区域样式 */
        .charts {
            flex: 1.1;
            display: flex;
            flex-direction: column;
            gap: 19px;
            padding: 10px 10px 0 10px;
            box-sizing: border-box;
        }

        /* 每个图表容器 */
        .chart-container {
            flex: 1;
            background: rgba(177, 179, 184, 0.7);
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(89, 95, 98, 0.15);
            padding: 5px;
            border: 1px solid rgba(40, 48, 55, 0.45);
            backdrop-filter: blur(5px);
        }

        /* 县名称显示元素样式 */
        #county-name {
            position: absolute;
            bottom: 10px;
            right: 10px;
            color: #e0e0e0;
            font-size: 16px;
            background: linear-gradient(90deg, rgba(0, 180, 255, 0.5), rgba(60, 100, 180, 0.5));
            padding: 8px 15px;
            border-radius: 5px;
            pointer-events: none;
            z-index: 1000;
            font-weight: bold;
            box-shadow: 0 0 8px rgba(0, 180, 255, 0.3);
        }

        /* 气象数据容器样式 */
        .weather-data-container {
            position: absolute;
            top: 105px;
            left: 10px;
            color: #e0e0e0;
            padding: 20px;
            z-index: 5;
            background: rgba(0, 10, 30, 0.4);
            border-radius: 8px;
            font-size: 14px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            box-shadow: 0 0 10px rgba(0, 150, 255, 0.15);
            backdrop-filter: blur(5px);
            min-width: 150px;
        }

        .weather-data-container h3 {
            margin-top: 0;
            font-size: 18px;
            margin-bottom: 15px;
            color: #00c8ff;
            text-shadow: 0 0 5px rgba(0, 200, 255, 0.5);
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
            padding-bottom: 5px;
        }

        .weather-data-container p {
            margin: 8px 0;
            display: flex;
            justify-content: space-between;
        }

        .weather-data-container span {
            font-weight: bold;
            color: #00c8ff;
        }

        /* 头部样式 */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 15px;
            background: rgba(0, 10, 30, 0.5);
            color: #e0e0e0;
            width: 100%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            border-bottom: 1px solid rgba(0, 150, 255, 0.3);
            backdrop-filter: blur(5px);
            z-index: 1000;
            position: relative;
            height: 50px; /* 固定高度 */
        }

        .header-title {
            font-size: 1.8em;
            margin: 0;
            flex-grow: 1;
            text-align: center;
            color: #00c8ff;
            text-shadow: 0 0 8px rgba(0, 200, 255, 0.5);
            letter-spacing: 2px;
        }

        .header-date {
            font-size: 1em;
            margin: 0;
            position: relative;
            left: -80px;
            color: #00c8ff;
            font-weight: bold;
        }

         /* 下拉菜单样式 */
        .dropdown {
            position: relative;
            display: inline-block;
            z-index: 1001;
        }

        .dropdown-btn {
            background: linear-gradient(90deg, rgba(0, 180, 255, 0.7), rgba(60, 100, 180, 0.7));
            color: white;
            padding: 10px 20px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 0 8px rgba(0, 180, 255, 0.3);
            transition: all 0.3s ease;
        }

        .dropdown-btn:hover {
            background: linear-gradient(90deg, rgba(0, 200, 255, 0.8), rgba(80, 120, 200, 0.8));
            transform: translateY(-2px);
            box-shadow: 0 0 12px rgba(0, 180, 255, 0.5);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: rgba(0, 10, 30, 0.9);
            min-width: 200px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            border-radius: 5px;
            border: 1px solid rgba(0, 150, 255, 0.3);
            z-index: 1001;
            backdrop-filter: blur(10px);
        }

        .dropdown-content a {
            color: #e0e0e0;
            padding: 12px 16px;
            text-decoration: none;
            display: block;
            transition: all 0.3s ease;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dropdown-content a:last-child {
            border-bottom: none;
        }

        .dropdown-content a:hover {
            background: rgba(0, 150, 255, 0.3);
            color: #00c8ff;
            padding-left: 20px;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-icon {
            font-size: 18px;
        }


        /* 添加机械未来风格的装饰元素 */
        .gear-decoration {
            position: absolute;
            width: 100px;
            height: 100px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M50,10 A40,40 0 1,1 50,90 A40,40 0 1,1 50,10 Z" fill="none" stroke="%2300c8ff" stroke-width="2"/><circle cx="50" cy="50" r="10" fill="%23000a1e" stroke="%2300c8ff" stroke-width="2"/><path d="M50,10 L50,30 M70,20 L55,35 M80,50 L60,50 M70,80 L55,65 M50,90 L50,70 M30,80 L45,65 M20,50 L40,50 M30,20 L45,35" stroke="%2300c8ff" stroke-width="2"/></svg>');
            opacity: 0.1;
            z-index: -1;
        }

        .gear-1 {
            top: 10%;
            left: 5%;
            animation: rotate 30s linear infinite;
        }

        .gear-2 {
            bottom: 15%;
            right: 8%;
            animation: rotate 40s linear infinite reverse;
        }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* 响应式设计 */
        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
            }
            
            #echarts-map {
                margin-left: 0;
                margin-bottom: 10px;
                flex: 2;
            }
            
            .charts {
                flex-direction: row;
                flex: 1;
            }
            
            .chart-container {
                flex: 1;
            }
        }

        @media (max-width: 768px) {
            .charts {
                flex-direction: column;
            }
            
            .header-title {
                font-size: 1.5em;
            }
            
            .header-date {
                font-size: 0.8em;
                left: 0;
            }
        }
    </style>
</head>
<body>

    <!-- 头部 -->
    <div class="header">
        <!-- 左侧下拉菜单 -->
        <div class="dropdown">
            <button class="dropdown-btn">
                <i class="dropdown-icon">☰</i> 导航菜单
            </button>
            <div class="dropdown-content">
                <a href="dashboard.html">气象监测大屏</a>
                <a href="data-analysis.html">数据分析中心</a>
                <a href="device-management.html">设备管理系统</a>
                <a href="weather-forecast.html">气象预报</a>
                <a href="alert-center.html">预警中心</a>
                <a href="user-center.html">用户个人中心</a>
            </div>
        </div>
        <h1 class="header-title">和田地区气象监测大屏</h1>
        <span class="header-date" id="current-date-time"></span>
    </div>

    <!-- 主内容区域 -->
    <div class="container">
        <!-- 地图容器 -->
        <div id="echarts-map"></div>
        <div id="county-name">点击显示县名称</div>

        <!-- 右侧的图表区域 -->
        <div class="charts">
            <!-- 温度折线图 -->
            <div id="temperature-chart" class="chart-container"></div>

            <!-- 湿度折线图 -->
            <div id="humidity-chart" class="chart-container"></div>

            <!-- 降水量柱状图 -->
            <div id="precipitation-chart" class="chart-container"></div>
        </div>
    </div>

    <!-- 地图左上角的气象数据容器 -->
    <div class="weather-data-container">
        <h3>实时气象数据</h3>
        <p>气温：<span id="temperature">--°C</span></p>
        <p>湿度：<span id="humidity">--%</span></p>
        <p>风速：<span id="windSpeed">-- km/h</span></p>
        <p>PM2.5：<span id="pm25">-- µg/m³</span></p>
        <p>PM10：<span id="pm10">-- µg/m³</span></p>
    </div>

    <script>
        // 配置后端API基础URL
        const API_BASE_URL = '/api'; // 根据你的SpringBoot端口修改
        const token = localStorage.getItem('token');
        

        // 获取当前日期和时间并格式化
        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const weekDays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
            const weekDay = weekDays[now.getDay()];

            const formattedDate = `${year}-${month}-${day} ${weekDay} ${hours}:${minutes}:${seconds}`;
            document.getElementById('current-date-time').textContent = formattedDate;
        }

        // 初始化时立即更新一次
        updateDateTime();

        // 每秒更新一次时间
        setInterval(updateDateTime, 1000);

        // 初始化ECharts地图
        function initEChartsMap() {
            var chartDom = document.getElementById('echarts-map');
            var myChart = echarts.init(chartDom);

            // 显示加载提示
            myChart.showLoading();

            // 静态资源获取地图数据
            fetch('./statics/data.geojson')
                .then(response => response.json())
                .then(data => {
                    echarts.registerMap('hetian', data);

                    // 获取地图数据
                    var mapFeatures = echarts.getMap('hetian').geoJson.features;
                    var mapData = mapFeatures.map(function(v) {
                        return { name: v.properties.name, value: Math.random() * 100 };
                    });

                    // 地图的option配置
                    var optionMap = {
                        geo: {
                            map: 'hetian',
                            roam: false,
                            aspectScale: 0.75,
                            layoutCenter: ["50%", "52.5%"],
                            layoutSize: '86%',
                            itemStyle: {
                                normal: {
                                    borderColor: 'rgba(133, 211, 223, 0.76)',
                                    borderWidth: 1.5,
                                    color: 'rgba(133, 211, 223, 0.76)',
                                    opacity: 0.8,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)',
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 25,
                                    shadowBlur: 18
                                },
                                emphasis: {
                                    areaColor: '#2a333d',
                                }
                            },
                            label: {
                                normal: {
                                    show: true,
                                    textStyle: {
                                        fontSize: 12,
                                        fontWeight: 400,
                                        color: '#fff'
                                    }
                                },
                                emphasis: {
                                    show: false
                                }
                            }
                        },
                        series: [{
                            type: 'map',
                            map: 'hetian',
                            data: mapData,
                            zoom: 1,
                            z: 1,
                            aspectScale: 0.75,
                            label: {
                                show: true,
                                textStyle: { color: '#fff' }
                            },
                            itemStyle: {
                                normal: {
                                    borderColor: 'rgba(147, 235, 248, 1)',
                                    borderWidth: 0.5,
                                    areaColor: '#2B91B7',
                                    shadowColor: 'rgba(0, 0, 0, 0.1)',
                                    shadowOffsetX: 0,
                                    shadowOffsetY: 14,
                                    shadowBlur: 10
                                },
                                emphasis: {
                                    areaColor: '#013159',
                                    label: {
                                        show: true,
                                        color: 'rgba(255, 255, 25, 1)',
                                        fontSize: 16,
                                        shadowColor: 'rgba(255, 215, 0, 0.7)',
                                        shadowOffsetX: 5,
                                        shadowOffsetY: 5,
                                        shadowBlur: 15
                                    },
                                }
                            }
                        }]
                    };

                    // 设置地图配置
                    myChart.setOption(optionMap);
                    myChart.hideLoading();

                    // 设置冷却期标志和冷却时间
                    let isCoolingDown = false;
                    const cooldownTime = 2000;

                    // 处理点击事件
                    myChart.on('click', function (params) {
                        if (params.name) {
                            if (isCoolingDown) {
                                alert('请勿频繁点击');
                                return;
                            }

                            var county = params.name;
                            document.getElementById('county-name').textContent = `县: ${county}`;

                            isCoolingDown = true;

                            // 发送请求到SpringBoot后端
                            fetch(`${API_BASE_URL}/weather/county-data`, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': `Bearer ${localStorage.getItem('token')}` // 如果有token验证
                                },
                                body: JSON.stringify({ county: county })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('网络响应不正常');
                                }
                                return response.json();
                            })
                            .then(response => {
                                if (response.code === 200) {
                                    const data = response.data;
                                    // 更新实时天气数据
                                    document.getElementById('temperature').textContent = `${data.currentWeather.temperature}°C`;
                                    document.getElementById('humidity').textContent = `${data.currentWeather.humidity}%`;
                                    document.getElementById('windSpeed').textContent = `${data.currentWeather.windSpeed} km/h`;
                                    document.getElementById('pm25').textContent = `${data.currentWeather.pm25} µg/m³`;
                                    document.getElementById('pm10').textContent = `${data.currentWeather.pm10} µg/m³`;

                                    loadWeatherDataByCounty(county);
                                } else {
                                    alert(response.message || '获取天气数据失败');
                                }
                            })
                            .catch(error => {
                                console.error('发送失败:', error);
                                alert('网络请求失败，请检查后端服务');
                            })
                            .finally(() => {
                                setTimeout(() => {
                                    isCoolingDown = false;
                                }, cooldownTime);
                            });
                        }
                    });

                })
                .catch(error => {
                    console.error('加载地图数据失败:', error);
                    myChart.hideLoading();
                    alert('地图数据加载失败');
                });
        }

        // 页面加载时初始化地图和初始数据
        document.addEventListener('DOMContentLoaded', function() {
            initEChartsMap();
            loadInitialWeatherData();
        });

        // 加载初始天气数据
        function loadInitialWeatherData() {
            fetch(`${API_BASE_URL}/weather/initial-data`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                },
                // 请求体为空，但 POST 仍需发送空 body 或 {}
                // 有些后端要求必须有 body
                body: JSON.stringify({}) // 有些后端要求必须有 body
            })
            .then(response => response.json())
            .then(response => {
                if (response.code === 200) {
                    const data = response.data.currentWeather;
                    // 更新初始天气数据
                    document.getElementById('temperature').textContent = `${data.temperature}°C`;
                    document.getElementById('humidity').textContent = `${data.humidity}%`;
                    document.getElementById('windSpeed').textContent = `${data.windSpeed} km/h`;
                    document.getElementById('pm25').textContent = `${data.pm25} µg/m³`;
                    document.getElementById('pm10').textContent = `${data.pm10} µg/m³`;
                    // ✅ 使用固定的默认经纬度（和田县）
                    const COUNTYNAME = "和田县";
                    // 加载初始图表数据
                    loadWeatherDataByCounty(COUNTYNAME);
                }
            })
            .catch(error => {
                console.error('加载初始数据失败:', error);
            });
        }

        // 更新图表数据并添加动画
        function updateCharts(weatherData) {
            if (!weatherData || !Array.isArray(weatherData.forecastData)) {
                console.error('天气数据格式错误');
                return;
            }
            const forecastData = weatherData.forecastData;

            const dates = forecastData.map(day => day.date);
            const temperatures_min = forecastData.map(day => parseInt(day.temperatureMin));
            const temperatures_max = forecastData.map(day => parseInt(day.temperatureMax));
            const humidities = forecastData.map(day => parseInt(day.humidity));
            const wind_speeds = forecastData.map(day => parseInt(day.windSpeed));
            const wind_directions = forecastData.map(day => parseInt(day.windDirection));

            // 固定坐标轴范围
            const fixedXAxisRange = [Math.min(...dates), Math.max(...dates)];
            const fixedYAxisRangeTemperature = [Math.min(...temperatures_min.concat(temperatures_max)) - 5, Math.max(...temperatures_min.concat(temperatures_max)) + 5];
            const fixedYAxisRangeHumidity = [0, 100];

            // 温度折线图数据
            const temperatureDataMin = {
                x: dates,
                y: Array(dates.length).fill(0),
                type: 'scatter',
                mode: 'lines+markers',
                name: '最低温度',
                marker: { color: 'rgba(30,144,255,0.5)' }
            };
            
            const temperatureDataMax = {
                x: dates,
                y: Array(dates.length).fill(0),
                type: 'scatter',
                mode: 'lines+markers',
                name: '最高温度',
                marker: { color: 'rgba(255,140,0,0.5)' }
            };

            // 湿度柱状图数据
            const humidityData = {
                x: dates,
                y: Array(dates.length).fill(0),
                type: 'bar',
                name: '湿度',
                marker: { color: 'rgba(0,206,209,0.5)' }
            };

            // 风向数据处理
            const sortedWindData = wind_directions.map((direction, index) => ({
                direction: direction,
                speed: wind_speeds[index],
                date: dates[index]
            }));

            sortedWindData.sort((a, b) => a.direction - b.direction);
            const sortedWindSpeeds = sortedWindData.map(item => item.speed);
            const sortedWindDirections = sortedWindData.map(item => item.direction);

            // 风力雷达图数据
            const RadarData = {
                r: Array(sortedWindSpeeds.length).fill(0),
                theta: sortedWindDirections.concat(sortedWindDirections[0]),
                type: 'scatterpolar',
                mode: 'lines+markers',
                name: '风力雷达图',
                line: { color: 'rgba(0,0,139,0.4)', width: 2 },
                fill: 'toself',
                fillcolor: 'rgba(0, 0, 255, 0.2)',
                marker: { size: 6 },
            };

            // 更新温度图表
            Plotly.react('temperature-chart', [temperatureDataMin, temperatureDataMax], {
                title: '未来七日温度变化',
                xaxis: { title: '日期', range: fixedXAxisRange },
                yaxis: { title: '温度 (°C)', range: fixedYAxisRangeTemperature },
                margin: { t: 70, b: 70, l: 70, r: 0 },
                staticPlot: false,
                displayModeBar: false,
                plot_bgcolor: 'rgba(0, 0, 0, 0)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)'
            });

            // 更新湿度图表
            Plotly.react('humidity-chart', [humidityData], {
                title: '未来七日湿度变化',
                xaxis: { title: '日期', range: fixedXAxisRange },
                yaxis: { title: '湿度 (%)', range: fixedYAxisRangeHumidity },
                margin: { t: 70, b: 70, l: 70, r: 40 },
                staticPlot: true,
                displayModeBar: false,
                plot_bgcolor: 'rgba(0, 0, 0, 0)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)'
            });

            // 更新风力雷达图
            Plotly.newPlot('precipitation-chart', [RadarData], {
                title: '未来七日风力变化',
                polar: {
                    radialaxis: {
                        visible: true,
                        range: [0, Math.max(...sortedWindSpeeds) + 1]
                    }
                },
                margin: { t: 70, b: 20, l: 10, r: 10 },
                staticPlot: false,
                displayModeBar: false,
                plot_bgcolor: 'rgba(0, 0, 0, 0)',
                paper_bgcolor: 'rgba(0, 0, 0, 0)'
            });

            // 动画效果
            animateCharts(dates, temperatures_min, temperatures_max, humidities, sortedWindSpeeds, sortedWindDirections);
        }

        // 图表动画效果
        function animateCharts(dates, tempMin, tempMax, humidity, windSpeeds, windDirections) {
            // 风力雷达图动画
            let currentR = Array(windSpeeds.length).fill(0);
            let step = 0;
            const totalSteps = 70;
            const intervalTime = 20;

            const interval = setInterval(() => {
                if (step < totalSteps) {
                    for (let i = 0; i < currentR.length; i++) {
                        currentR[i] = (windSpeeds[i] * step) / totalSteps;
                    }

                    Plotly.update('precipitation-chart', {
                        r: [currentR.concat(currentR[0])],
                        theta: [windDirections.concat(windDirections[0])],
                    });

                    step++;
                } else {
                    clearInterval(interval);
                }
            }, intervalTime);

            // 温度和湿度动画
            setTimeout(() => {
                Plotly.animate('temperature-chart', {
                    data: [
                        { x: dates, y: tempMin },
                        { x: dates, y: tempMax }
                    ]
                }, {
                    frame: { duration: 2000, redraw: false },
                    transition: { duration: 5000, easing: 'ease-out' }
                });

                Plotly.animate('humidity-chart', {
                    data: [{ x: dates, y: humidity }]
                }, {
                    frame: { duration: 2000, redraw: false },
                    transition: { duration: 5000, easing: 'ease-out' }
                });
            }, 100);
        }

        // 根据县名加载天气数据
        function loadWeatherDataByCounty(countyName) {
            fetch(`${API_BASE_URL}/weather/forecast-county`, {
                method:'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify({ county: countyName })
            })
            .then(response => response.json())
            .then(response => {
                if (response.code === 200) {
                    updateCharts(response.data);
                }
            })
            .catch(error => {
                console.error('获取天气数据失败:', error);
            });
        }


        // 错误处理
        window.addEventListener('error', function(e) {
            console.error('全局错误:', e.error);
        });
    </script>
</body>
</html>